# Software Architecture

## System Overview

Two codebases:

1. **Builder app** — Next.js, hosted on Vercel. Customer-facing. Where users design their dashboard via AI prompting.
2. **Dashboard template** — React + Vite. Runs inside a Vercel Sandbox for live preview. Eventually builds to static files deployed on the physical device.

An AI agent connects the two: user prompts in the builder, agent modifies code in the sandbox, Vite HMR refreshes the preview in real time.

---

## Home Assistant Communication

The device communicates with Home Assistant via WebSocket over the local network. No internet required.

### Package Analysis

| Package | License | Maturity | Verdict |
|---------|---------|----------|---------|
| `home-assistant-js-websocket` | Apache 2.0 | Official HA package, used by HA's own frontend, actively maintained | **Use this** |
| `@hakit/core` | MIT | Community React hooks wrapping the above, ~300 stars, single maintainer | Skip — dependency risk for little gain |

### Decision

Use `home-assistant-js-websocket` directly. Apache 2.0 is fully commercial-friendly. Build a thin `<HomeAssistantProvider>` React context on top that exposes:

- Entity state subscriptions (`subscribeEntities`)
- Service calls (`callService`)
- Connection management with long-lived access tokens

For Phase 1, components use mock data. Real HA adapter comes in Phase 2.

---

## Builder App (Next.js)

### Stack

| Layer | Choice | Why |
|-------|--------|-----|
| Framework | Next.js (App Router) | Vercel-native, AI SDK integration |
| AI | Vercel AI SDK + AI Gateway | `streamText` with tools, provider fallbacks |
| Sandbox | `@vercel/sandbox` | Isolated filesystem, port forwarding |
| Styling | Tailwind CSS | AI-generatable, consistent |

### Key Routes

| Route | Purpose |
|-------|---------|
| `/` | Landing page — "Add new device" |
| `/device/[id]` | Dashboard editor — preview iframe + chat prompt |
| `/api/chat` | AI agent endpoint |
| `/api/sandbox` | Sandbox lifecycle (create, manage) |

---

## Dashboard Template (React + Vite)

Runs inside the Vercel Sandbox. The AI agent edits `Dashboard.tsx` to arrange and configure components.

### Pre-built Components (Phase 1)

| Component | Purpose | Key Props |
|-----------|---------|-----------|
| `WeatherCard` | Temperature, condition, forecast | `location`, `temperature`, `condition`, `humidity` |
| `LightSwitch` | Toggle + brightness slider | `entityName`, `isOn`, `brightness`, `onToggle` |
| `MusicPlayer` | Track info, playback controls | `trackName`, `artist`, `isPlaying`, `onPlayPause` |

Dark theme, rounded cards, subtle gradients, smooth transitions. Mushroom-inspired aesthetic in React + Tailwind.

### Data Layer

- `mock-data.ts` — fake HA entity states for preview mode
- `ha-provider.tsx` — context provider interface. Returns mock data in sandbox, real WebSocket data on device.

---

## AI Agent

### How It Works

1. User types a prompt in the chat bar
2. `useChat` sends it to `/api/chat`
3. Agent uses `streamText` with tools to read/modify sandbox files
4. Vite HMR picks up file changes, iframe refreshes automatically

### Tools

| Tool | Description |
|------|-------------|
| `readFile` | Read a file from the sandbox |
| `writeFile` | Write/overwrite a file in the sandbox |
| `listFiles` | List directory contents |

### System Prompt

Includes:
- Available components and their props
- Dashboard layout structure
- Instruction to modify `Dashboard.tsx` primarily
- Tailwind CSS conventions
- Mock data shape

### Model

Via AI Gateway — e.g. `anthropic/claude-sonnet-4` with fallbacks. No vendor lock-in.

---

## Phase 1 User Flow

1. Open builder app
2. Click "Add new device"
3. Enter device code (10 chars, alphanumeric — generated by the physical device)
4. Select location: Kitchen / Living Room / Bedroom / Hallway / Other
5. Submit → sandbox created, template seeded, dev server started
6. Redirected to editor: full-screen preview (iframe) + chat bar at bottom
7. Default layout: WeatherCard (top), MusicPlayer (middle), LightSwitch (bottom-left)
8. Prompt to modify → agent edits code → preview updates live

---

## Phase 1 Boundaries

**In scope:**
- Device registration (simulated)
- Sandbox creation + template seeding
- Live preview via iframe
- Chat-based AI prompting
- Three pre-built components
- Mock HA data

**Out of scope (Phase 2+):**
- Supabase (auth, database, user profiles)
- Real device pairing (Bluetooth + WiFi)
- Real HA WebSocket connection
- Build + deploy to physical device
- Credit/payment system
- Multi-user, multi-sandbox
